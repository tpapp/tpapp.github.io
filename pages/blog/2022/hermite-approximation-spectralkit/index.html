<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <link rel=stylesheet  href="/libs/katex/katex.min.css"> <link rel=stylesheet  href="/libs/highlight/github.min.css"> <link href="/css/style.css" rel=stylesheet > <script src="/libs/vela/jquery.min.js"></script> <link rel=icon  href="/assets/favicon.png"> <title>Tamás K. Papp &mdash; Approximating a function using derivatives</title> <div id = "navbar"> <a href="/">About</a> <a href="/pages/research">Research</a> <a href="/pages/blog">Blog</a> <a href="/pages/teaching">Teaching</a> <a href="https://github.com/tpapp/">Github</a> <div class=dropdown > <a class=dropdown-button >(tags)</a> <div class=dropdown-content > <p class=dropdown-header >site tags</p> <a href="/tag/julia">julia</a> <a href="/tag/announcement">announcement</a> <a href="/tag/numerical">numerical</a> <a href="/tag/spectralkitjl">SpectralKit.jl</a> <a href="/tag/markdown">markdown</a> <a href="/tag/franklin">franklin</a> </div> </div> <a href="/feed.xml" type="application/rss+xml" target=_blank ><img class=feedicon  src="/assets/img/feed_icon.svg" alt="Atom feed (blog)" title="Atom feed (blog)"></a> </div> <div class=main-content > <h1 class=title >Approximating a function using derivatives</h1> <div class=tags > <span class=date >2022-09-20</date></span> <a href="/tag/julia">julia</a> <a href="/tag/numerical">numerical</a> <a href="/tag/spectralkitjl">SpectralKit.jl</a> </div> <div class=franklin-content > <p>When simulating from an economic model, I had to approximate a function <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy=false >(</mo><mi>x</mi><mo separator=true >;</mo><mi>θ</mi><mo stretchy=false >)</mo><mo>:</mo><mo stretchy=false >[</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo><mo>→</mo><mo stretchy=false >[</mo><mn>0</mn><mo separator=true >,</mo><mn>1</mn><mo stretchy=false >]</mo></mrow><annotation encoding="application/x-tex">f(x; \theta): [0,1] \to [0,1]</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mpunct >;</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >:</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >]</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >→</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class=mopen >[</span><span class=mord >0</span><span class=mpunct >,</span><span class=mspace  style="margin-right:0.16666666666666666em;"></span><span class=mord >1</span><span class=mclose >]</span></span></span></span> for a variety of <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>θ</mi></mrow><annotation encoding="application/x-tex">\theta</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span></span></span></span>s. <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi></mrow><annotation encoding="application/x-tex">f</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span></span></span></span> itself has to be solved for numerically, but otherwise it is pretty friendly, being continuous and increasing, with <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy=false >(</mo><mn>0</mn><mo stretchy=false >)</mo><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">f(0)=0</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=mopen >(</span><span class=mord >0</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >0</span></span></span></span> and <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mo stretchy=false >(</mo><mn>1</mn><mo stretchy=false >)</mo><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">f(1)=1</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=mopen >(</span><span class=mord >1</span><span class=mclose >)</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span><span class=mrel >=</span><span class=mspace  style="margin-right:0.2777777777777778em;"></span></span><span class=base ><span class=strut  style="height:0.64444em;vertical-align:0em;"></span><span class=mord >1</span></span></span></span>.</p> <p>After profiling, this turned out to be the most costly part, so I had to approximate it. Since I needed derivatives <span class=katex ><span class=katex-mathml ><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>f</mi><mo mathvariant=normal  lspace=0em  rspace=0em >′</mo></msup><mo stretchy=false >(</mo><mi>x</mi><mo stretchy=false >)</mo></mrow><annotation encoding="application/x-tex">f&#x27;(x)</annotation></semantics></math></span><span class=katex-html  aria-hidden=true ><span class=base ><span class=strut  style="height:1.001892em;vertical-align:-0.25em;"></span><span class=mord ><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class=msupsub ><span class=vlist-t ><span class=vlist-r ><span class=vlist  style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class=pstrut  style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class=mopen >(</span><span class="mord mathnormal">x</span><span class=mclose >)</span></span></span></span>, I was wondering whether making the approximation match them &#40;known as a <a href="https://en.wikipedia.org/wiki/Hermite_interpolation">Hermite interpolation</a>&#41; would increase accuracy.</p> <p>The &#40;pedagogical, unoptimized&#41; code below sums up the gist of my numerical experiments, with <code>f</code> below standing in for my implicitly solved function. It also demonstrates the new features of <a href="https://github.com/tpapp/SpectralKit.jl/">SpectralKit.jl</a> <code>v0.10</code>.</p> <p>First, we set up the problem:</p> <pre><code class="julia hljs"><span class=hljs-keyword >using</span> SpectralKit, PGFPlotsX, DisplayAs

f(x) = (exp(x) - <span class=hljs-number >1</span>) / (exp(<span class=hljs-number >1</span>) - <span class=hljs-number >1</span>)
f′(x) = exp(x) / (exp(<span class=hljs-number >1</span>) - <span class=hljs-number >1</span>)
<span class=hljs-keyword >const</span> I = BoundedLinear(<span class=hljs-number >0</span>, <span class=hljs-number >1</span>)   <span class=hljs-comment ># interval we map from</span></code></pre> <p>Then define an interpolation using <code>N</code> Chebyshev nodes, matching the values.</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> interpolation0(f, N)
    basis = Chebyshev(EndpointGrid(), N)
    ϕ = collocation_matrix(basis) \ map(f ∘ from_pm1(I), grid(basis))
    linear_combination(basis, ϕ) ∘ to_pm1(I)
<span class=hljs-keyword >end</span>;</code></pre> <p>Same exercise, but with the derivatives too, so we need two bases, one with double the number of functions &#40;so we need to make sure <code>N</code> is even&#41;, while we just use <code>N/2</code> for the nodes.</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> interpolation01(f, f′, N)
    <span class=hljs-meta >@assert</span> iseven(N)
    basis1 = Chebyshev(EndpointGrid(), N ÷ <span class=hljs-number >2</span>) <span class=hljs-comment ># nodes from this one</span>
    basis2 = Chebyshev(EndpointGrid(), N)     <span class=hljs-comment ># evaluate on this basis</span>
    x = from_pm1.(I, grid(basis1))            <span class=hljs-comment ># map nodes from [-1,1]</span>
    M = collocation_matrix(basis2, to_pm1.(I, derivatives.(x)))
    ϕ = vcat(map(y -&gt; y[<span class=hljs-number >0</span>], M), map(y -&gt; y[<span class=hljs-number >1</span>], M)) \ vcat(f.(x), f′.(x))
    linear_combination(basis2, ϕ) ∘ to_pm1(I)
<span class=hljs-keyword >end</span>;</code></pre> <p>Importantly, note that mapping to &#91;-1,1&#93; for the collocation matrix has to be preceded by lifting to derivatives.</p> <p>Then calculate the max abs difference, in digits &#40;<code>log10</code>&#41;.</p> <pre><code class="julia hljs"><span class=hljs-keyword >function</span> log10_max_abs_diff(f, f̂; M = <span class=hljs-number >1000</span>)
    x = range(<span class=hljs-number >0</span>, <span class=hljs-number >1</span>; length = M)
    log10(maximum(@. abs(f(x) - f̂(x))))
<span class=hljs-keyword >end</span>;</code></pre> <p>Then let&#39;s explore the errors in values ...</p> <pre><code class="julia hljs">Ns = <span class=hljs-number >4</span>:<span class=hljs-number >2</span>:<span class=hljs-number >20</span>
errors = [(log10_max_abs_diff(f, interpolation0(f, N)),
           log10_max_abs_diff(f, interpolation01(f, f′, N)))
          <span class=hljs-keyword >for</span> N <span class=hljs-keyword >in</span> Ns]</code></pre> <pre><code class="julia hljs"><span class=hljs-number >9</span>-element <span class=hljs-built_in >Vector</span>{<span class=hljs-built_in >Tuple</span>{<span class=hljs-built_in >Float64</span>, <span class=hljs-built_in >Float64</span>}}:
 (-<span class=hljs-number >3.1996028783051695</span>, -<span class=hljs-number >2.594513489315976</span>)
 (-<span class=hljs-number >5.882145733021446</span>, -<span class=hljs-number >5.488666848393999</span>)
 (-<span class=hljs-number >8.835160643191552</span>, -<span class=hljs-number >8.232779398084544</span>)
 (-<span class=hljs-number >11.994023867372805</span>, -<span class=hljs-number >11.44897859894945</span>)
 (-<span class=hljs-number >15.176438519807359</span>, -<span class=hljs-number >14.664555158828485</span>)
 (-<span class=hljs-number >15.35252977886304</span>, -<span class=hljs-number >15.35252977886304</span>)
 (-<span class=hljs-number >15.255619765854984</span>, -<span class=hljs-number >15.35252977886304</span>)
 (-<span class=hljs-number >15.35252977886304</span>, -<span class=hljs-number >15.35252977886304</span>)
 (-<span class=hljs-number >15.35252977886304</span>, -<span class=hljs-number >15.35252977886304</span>)</code></pre> <p>... and derivatives.</p> <pre><code class="julia hljs">d_errors = [(log10_max_abs_diff(f′, (x -&gt; x[<span class=hljs-number >1</span>]) ∘ interpolation0(f, N) ∘ derivatives),
             log10_max_abs_diff(f′, (x -&gt; x[<span class=hljs-number >1</span>]) ∘ interpolation01(f, f′, N) ∘ derivatives))
            <span class=hljs-keyword >for</span> N <span class=hljs-keyword >in</span> Ns]</code></pre> <pre><code class="julia hljs"><span class=hljs-number >9</span>-element <span class=hljs-built_in >Vector</span>{<span class=hljs-built_in >Tuple</span>{<span class=hljs-built_in >Float64</span>, <span class=hljs-built_in >Float64</span>}}:
 (-<span class=hljs-number >2.0758500387125216</span>, -<span class=hljs-number >2.093336352131656</span>)
 (-<span class=hljs-number >4.549339116162139</span>, -<span class=hljs-number >4.611253272379436</span>)
 (-<span class=hljs-number >7.363367596306161</span>, -<span class=hljs-number >7.429305371299876</span>)
 (-<span class=hljs-number >10.417554370684012</span>, -<span class=hljs-number >10.485171320264207</span>)
 (-<span class=hljs-number >13.381718167990524</span>, -<span class=hljs-number >13.689771947181466</span>)
 (-<span class=hljs-number >13.834015838985154</span>, -<span class=hljs-number >14.374806173574193</span>)
 (-<span class=hljs-number >14.03551167781493</span>, -<span class=hljs-number >14.539616422220185</span>)
 (-<span class=hljs-number >13.724140848812729</span>, -<span class=hljs-number >14.750469787535078</span>)
 (-<span class=hljs-number >13.714040521908403</span>, -<span class=hljs-number >14.724140848812729</span>)</code></pre> <p>Finally the plots:</p> <pre><code class="julia hljs"><span class=hljs-meta >@pgf</span> Axis({ xlabel = <span class=hljs-string >&quot;number of basis functions&quot;</span>,
            ylabel = <span class=hljs-string >&quot;log10 abs error in values&quot;</span>,
            legend_cell_align= <span class=hljs-string >&quot;left&quot;</span> },
          PlotInc(Table(Ns, first.(errors))),
          LegendEntry(<span class=hljs-string >&quot;fitting values&quot;</span>),
          PlotInc(Table(Ns, last.(errors))),
          LegendEntry(<span class=hljs-string >&quot;fitting values and derivatives&quot;</span>)) |&gt; DisplayAs.SVG</code></pre> <p><img src=2197788484.svg  alt="" /></p> <pre><code class="julia hljs"><span class=hljs-meta >@pgf</span> Axis({ xlabel = <span class=hljs-string >&quot;number of basis functions&quot;</span>,
            ylabel = <span class=hljs-string >&quot;log10 abs error in values&quot;</span>,
            legend_cell_align= <span class=hljs-string >&quot;left&quot;</span> },
          PlotInc(Table(Ns, first.(d_errors))),
          LegendEntry(<span class=hljs-string >&quot;fitting values&quot;</span>),
          PlotInc(Table(Ns, last.(d_errors))),
          LegendEntry(<span class=hljs-string >&quot;fitting values and derivatives&quot;</span>)) |&gt; DisplayAs.SVG</code></pre> <p><img src=3226471975.svg  alt="" /></p> <p>The conclusion is that even without matching them explicitly, derivatives are well-approximated. Getting an extra digit of accuracy in derivatives above 12–14 nodes means sacrificing a digit of accuracy with a low number of nodes. 14 seems to be the break-even point here, but then we are at machine precision anyway.</p> <p>As usual, simply approximating with Chebyshev polynomials is extremely accurate in itself for practical purposes, even when derivatives are needed. Of course, this depends on the function being “nice”.</p> <p> <div class=source_footer > This page was generated using <a href="https://github.com/fredrikekre/Literate.jl">Literate.jl</a>.<br />Download <a href=hermite-approximation-spectralkit_source.tar >the source, project, and manifest</a>. </div> </p> <script src="https://utteranc.es/client.js" repo="tpapp/tpapp.github.io-comments" issue-term=pathname  label=comment  theme=github-light  crossorigin=anonymous  async> </script> <div class=page-foot > <div class=copyright > &copy; Tamás K. Papp. Last modified: September 29, 2022. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>. </div> </div> </div></div> </main> <script src="/libs/vela/metisMenu.min.js"></script> <script src="/libs/vela/slideout.min.js"></script>