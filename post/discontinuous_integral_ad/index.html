<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Automatic differentiation of discontinuous integrals</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="Hugo 0.69.2" />
    <link rel="stylesheet" type="text/css" href="../../css/style.css">
    <link rel="stylesheet" type="text/css" href="../../css/syntax.css">
    
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif:400,400i,700,700i|Ubuntu+Mono&display=swap&subset=latin-ext" rel="stylesheet"> 
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          
          
          processEscapes: true,
          processEnvironments: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
          TeX: { equationNumbers: { autoNumber: "AMS" },
          extensions: ["AMSmath.js", "AMSsymbols.js"] }
          },
        CommonHTML: { linebreaks: { automatic: true } },
        "HTML-CSS": { linebreaks: { automatic: true } },
        SVG: { linebreaks: { automatic: true } }
      });
    </script>
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>
  <body>
    <nav id="navbar">
      <a href="https://tamaspapp.eu/">About</a>
<a href="https://tamaspapp.eu/research">Research</a>
<a href="https://tamaspapp.eu/teaching">Teaching</a>
<a href="https://tamaspapp.eu/post">Blog</a>
<a href="https://github.com/tpapp/">Github</a>
<div class="dropdown">
  <a class="dropdown-button">(tags)</a>
  <div class="dropdown-content">
    <p class="dropdown-header">site tags</p>
    
    <a href="../../tags/automatic-differentiation">automatic-differentiation</a>
    
    <a href="../../tags/bayesian">bayesian</a>
    
    <a href="../../tags/big-data">big-data</a>
    
    <a href="../../tags/blogging">blogging</a>
    
    <a href="../../tags/browser-plugins">browser-plugins</a>
    
    <a href="../../tags/coverage">coverage</a>
    
    <a href="../../tags/docker">docker</a>
    
    <a href="../../tags/emacs">emacs</a>
    
    <a href="../../tags/emacs25">emacs25</a>
    
    <a href="../../tags/firefox">firefox</a>
    
    <a href="../../tags/forwarddiff">forwarddiff</a>
    
    <a href="../../tags/gitlab">gitlab</a>
    
    <a href="../../tags/hugo">hugo</a>
    
    <a href="../../tags/indirect-inference">indirect-inference</a>
    
    <a href="../../tags/jacobian">jacobian</a>
    
    <a href="../../tags/julia">julia</a>
    
    <a href="../../tags/julia-repl">julia-repl</a>
    
    <a href="../../tags/latex">latex</a>
    
    <a href="../../tags/lisp">lisp</a>
    
    <a href="../../tags/log1p">log1p</a>
    
    <a href="../../tags/magit">magit</a>
    
    <a href="../../tags/math">math</a>
    
    <a href="../../tags/mcmc">mcmc</a>
    
    <a href="../../tags/microoptimization">microoptimization</a>
    
    <a href="../../tags/numerical-error">numerical-error</a>
    
    <a href="../../tags/packages">packages</a>
    
    <a href="../../tags/plots">plots</a>
    
    <a href="../../tags/stan">stan</a>
    
    <a href="../../tags/teaching">teaching</a>
    
    <a href="../../tags/ubuntu">ubuntu</a>
    
    <a href="../../tags/unit-testing">unit-testing</a>
    
    <a href="../../tags/weave">weave</a>
    
  </div>
</div>
<a href="https://tamaspapp.eu/post/index.xml" type="application/rss+xml" target="_blank"><img class="feedicon" src="https://tamaspapp.eu/img/feed-icon.svg" alt="Atom feed (blog)" title="Atom feed (blog)"></a>

    </nav>
    <div id="navbarplaceholder">
      <a href="https://tamaspapp.eu/">About</a>
<a href="https://tamaspapp.eu/research">Research</a>
<a href="https://tamaspapp.eu/teaching">Teaching</a>
<a href="https://tamaspapp.eu/post">Blog</a>
<a href="https://github.com/tpapp/">Github</a>
<div class="dropdown">
  <a class="dropdown-button">(tags)</a>
  <div class="dropdown-content">
    <p class="dropdown-header">site tags</p>
    
    <a href="../../tags/automatic-differentiation">automatic-differentiation</a>
    
    <a href="../../tags/bayesian">bayesian</a>
    
    <a href="../../tags/big-data">big-data</a>
    
    <a href="../../tags/blogging">blogging</a>
    
    <a href="../../tags/browser-plugins">browser-plugins</a>
    
    <a href="../../tags/coverage">coverage</a>
    
    <a href="../../tags/docker">docker</a>
    
    <a href="../../tags/emacs">emacs</a>
    
    <a href="../../tags/emacs25">emacs25</a>
    
    <a href="../../tags/firefox">firefox</a>
    
    <a href="../../tags/forwarddiff">forwarddiff</a>
    
    <a href="../../tags/gitlab">gitlab</a>
    
    <a href="../../tags/hugo">hugo</a>
    
    <a href="../../tags/indirect-inference">indirect-inference</a>
    
    <a href="../../tags/jacobian">jacobian</a>
    
    <a href="../../tags/julia">julia</a>
    
    <a href="../../tags/julia-repl">julia-repl</a>
    
    <a href="../../tags/latex">latex</a>
    
    <a href="../../tags/lisp">lisp</a>
    
    <a href="../../tags/log1p">log1p</a>
    
    <a href="../../tags/magit">magit</a>
    
    <a href="../../tags/math">math</a>
    
    <a href="../../tags/mcmc">mcmc</a>
    
    <a href="../../tags/microoptimization">microoptimization</a>
    
    <a href="../../tags/numerical-error">numerical-error</a>
    
    <a href="../../tags/packages">packages</a>
    
    <a href="../../tags/plots">plots</a>
    
    <a href="../../tags/stan">stan</a>
    
    <a href="../../tags/teaching">teaching</a>
    
    <a href="../../tags/ubuntu">ubuntu</a>
    
    <a href="../../tags/unit-testing">unit-testing</a>
    
    <a href="../../tags/weave">weave</a>
    
  </div>
</div>
<a href="https://tamaspapp.eu/post/index.xml" type="application/rss+xml" target="_blank"><img class="feedicon" src="https://tamaspapp.eu/img/feed-icon.svg" alt="Atom feed (blog)" title="Atom feed (blog)"></a>

    </div>
    <div id="mainbody">

<div id="content">
<h1>Automatic differentiation of discontinuous integrals</h1>2017/09/15
<span class="tags">
    
    <a href="../../tags/julia">julia</a>
    
    <a href="../../tags/automatic-differentiation">automatic differentiation</a>
    
    <a href="../../tags/forwarddiff">ForwardDiff</a>
    
</span>




<div id="pagenav">
  
  <span class="pagenav-label">previous post:</span>&nbsp;
  <a href="https://tamaspapp.eu/post/log1p/">log1p in Julia</a>
  
  
  
  <br/>
  
  <span class="pagenav-label">next post:</span>&nbsp;
  <a href="https://tamaspapp.eu/post/blog-redesign-201709/">Blog redesign 2.0</a>
  
</div>


<p>This is a <em>much simplified</em> writeup of a problem I encountered, in a self-contained blog post.</p>

<p>You want to approximate the integral</p>

<p><span  class="math">\[
I(\theta) = \int 1(g(x) > 0) f(x,\theta) dx
\]</span></p>

<p>where <span  class="math">\(g\)</span> is a continuous function, and <span  class="math">\(f(x,\theta)\)</span> is a parametric distribution over <span  class="math">\(x\)</span>. Everthing is continous, and thus <span  class="math">\(I\)</span> is, too.</p>

<p>You face the following constraints:</p>

<ol>
<li><p><span  class="math">\(g\)</span> is a black box. We will pretend that you can't invert it (except for checking our results, of course).</p></li>

<li><p>You can calculate the probability density function <span  class="math">\(f\)</span> and even draw <span  class="math">\(x\)</span>'s for a particular <span  class="math">\(\theta\)</span>, but that's pretty much it. You don't even get a cdf! (Again, except for checking our results.)</p></li>
</ol>

<p>Using Monte Carlo methods, you can do the following:</p>

<ol>
<li><p>draw <span  class="math">\(x_i \sim F(\cdot, \theta)\)</span>, <span  class="math">\(i=1,\dots,N\)</span>,</p></li>

<li><p>approximate</p></li>
</ol>

<p><span  class="math">\[
I(\theta) \approx \frac{1}{N}\sum_i 1(g(x_i) > 0)
\]</span></p>

<p>You could code this in Julia as</p>
<div class="highlight"><pre class="chroma"><code class="language-julia" data-lang="julia"><span class="n">d</span> <span class="o">=</span> <span class="n">distr</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span>   <span class="c"># suppose this returns some distribution that supports Base.rand</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
<span class="n">mean</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span></code></pre></div>
<p>So far, neat and simple. Now, the fly in the ointment: <strong>you need the derivative</strong> <span  class="math">\(I'(\theta)\)</span> for optimization or Hamiltonian Monte Carlo. The problem is that you cannot <code>ForwardDiff</code> your way through the code above: AD'ing a discontinuous step function will just give you <span  class="math">\(0\)</span>, and <code>rand</code> does not work with <code>ForwardDiff.Dual</code>s anyway (which is very sensible).</p>

<p>However, there <em>is</em> a solution: rewrite the approximation as</p>

<p><span  class="math">\[
I(\theta; \theta_0) \approx \frac{1}{N}\sum_i 1(g(x_i) > 0) \frac{f(x_i,\theta)}{f(x_i,\theta_0)}
\]</span></p>

<p>where <span  class="math">\(\theta_0\)</span> is the parameter used to simulate the <span  class="math">\(x_i\)</span>. Differentiate the above at <span  class="math">\(\theta = \theta_0\)</span>. This approximates</p>

<p><span  class="math">\[
I'(\theta) = \int 1(g(x) > 0) \frac{\partial f(x,\theta)/\partial \theta}{f(x,\theta)}f(x,\theta) dx = \int 1(g(x) > 0) \partial f(x,\theta)/\partial \theta dx
\]</span></p>

<p>which is exactly what you want.</p>

<p>Assume that the actual calculation is very complicated, so we would rather avoid implementing it for the integral and the derivative separately. It turns out that this is very simple to do with <code>ForwardDiff.Dual</code> values: the code is literally a one-liner and a fallback method:</p>
<div class="highlight"><pre class="chroma"><code class="language-julia" data-lang="julia"><span class="n">elasticity</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="kt">Real</span><span class="p">)</span> <span class="o">=</span> <span class="n">one</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">elasticity</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="n">Dual</span><span class="p">{</span><span class="n">T</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">N</span><span class="p">})</span> <span class="n">where</span> <span class="p">{</span><span class="n">T</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">N</span><span class="p">}</span> <span class="o">=</span> <span class="n">Dual</span><span class="p">{</span><span class="n">T</span><span class="p">}(</span><span class="n">one</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">partials</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></code></pre></div>
<p>which you can use in a function like</p>
<div class="highlight"><pre class="chroma"><code class="language-julia" data-lang="julia"><span class="n">integral_approx</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">mean</span><span class="p">((</span><span class="n">g</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">.&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.*</span> <span class="n">elasticity</span><span class="o">.</span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span></code></pre></div>
<p>I demonstrate this with <span  class="math">\(g(x) = x\)</span> and <span  class="math">\(x \sim \text{Normal}(\theta, 1)\)</span>, for which of course we know that the analytical values for <span  class="math">\(I\)</span> and <span  class="math">\(I'\)</span> are the right tail probability and the pdf at 0, respectively.</p>

<p>Graphs below show that the approximation is reasonable — we could make it much better with <a href="https://github.com/stevengj/Sobol.jl">low-discrepancy sequences</a>, but that is an orthogonal issue.</p>



<img src="../../post/discontinuous_integral_ad/integral.svg" alt="integral">




<img src="../../post/discontinuous_integral_ad/derivative.svg" alt="derivative">


<p>It is amazing how much you can accomplish with two lines of code in Julia! The problem that motivated this blog post is multivariate with irregular regions over which <span  class="math">\(\{ x: g(x) > 0 \}\)</span>, but I used <code>elasticity</code> as above.</p>

<p>Self-contained code for everything is available below.</p>




<div class="codedisplay">
  <div class="codeheader"><p>download as <a href="https://tamaspapp.eu/post/discontinuous_integral_ad/code.jl">code.jl</a></p></div>
  <div class="highlight"><pre class="chroma"><code class="language-julia" data-lang="julia"><span class="k">using</span> <span class="n">ForwardDiff</span>
<span class="k">import</span> <span class="n">ForwardDiff</span><span class="o">:</span> <span class="n">Dual</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">partials</span><span class="p">,</span> <span class="n">Tag</span>
<span class="k">using</span> <span class="n">Distributions</span>
<span class="k">using</span> <span class="n">Plots</span>
<span class="k">using</span> <span class="n">LaTeXStrings</span>
<span class="n">gr</span><span class="p">()</span>

<span class="c">######################################################################</span>
<span class="c"># elasticity calculation</span>
<span class="c">######################################################################</span>

<span class="s">&#34;&#34;&#34;
</span><span class="s">    elasticity(x)
</span><span class="s">
</span><span class="s">Calculate `x/x`, stripping `x` of partial derivative information. Useful for
</span><span class="s">calculating elasticities of the form `∂f/f` using ForwardDiff.
</span><span class="s">&#34;&#34;&#34;</span>
<span class="n">elasticity</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="kt">Real</span><span class="p">)</span> <span class="o">=</span> <span class="n">one</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">elasticity</span><span class="p">(</span><span class="n">x</span><span class="o">::</span><span class="n">Dual</span><span class="p">{</span><span class="n">T</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">N</span><span class="p">})</span> <span class="n">where</span> <span class="p">{</span><span class="n">T</span><span class="p">,</span><span class="n">V</span><span class="p">,</span><span class="n">N</span><span class="p">}</span> <span class="o">=</span> <span class="n">Dual</span><span class="p">{</span><span class="n">T</span><span class="p">}(</span><span class="n">one</span><span class="p">(</span><span class="n">V</span><span class="p">),</span> <span class="n">partials</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">value</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c">######################################################################</span>
<span class="c"># example application</span>
<span class="c">######################################################################</span>

<span class="n">integral_approx</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">mean</span><span class="p">((</span><span class="n">g</span><span class="o">.</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">.&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">.*</span> <span class="n">elasticity</span><span class="o">.</span><span class="p">(</span><span class="n">pdf</span><span class="o">.</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)))</span>

<span class="s">&#34;Helper function that returns the value and derivative at the same time.&#34;</span>
<span class="k">function</span> <span class="n">value_and_derivative</span><span class="p">(</span><span class="n">f</span><span class="o">::</span><span class="n">F</span><span class="p">,</span> <span class="n">x</span><span class="o">::</span><span class="n">R</span><span class="p">)</span> <span class="n">where</span> <span class="p">{</span><span class="n">F</span><span class="p">,</span><span class="n">R</span><span class="o">&lt;:</span><span class="kt">Real</span><span class="p">}</span>
    <span class="n">T</span> <span class="o">=</span> <span class="n">typeof</span><span class="p">(</span><span class="n">Tag</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">R</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">Dual</span><span class="p">{</span><span class="n">T</span><span class="p">}(</span><span class="n">x</span><span class="p">,</span> <span class="n">one</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
    <span class="n">value</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">partials</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">distr</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span> <span class="o">=</span> <span class="n">Normal</span><span class="p">(</span><span class="n">θ</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">=</span> <span class="n">x</span>

<span class="k">function</span> <span class="n">ID_analytical</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">distr</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span>
    <span class="n">ccdf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pdf</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">function</span> <span class="n">ID_approx</span><span class="p">(</span><span class="n">θ</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">rand</span><span class="p">(</span><span class="n">distr</span><span class="p">(</span><span class="n">θ</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">value_and_derivative</span><span class="p">(</span><span class="n">θ</span><span class="o">-&gt;</span><span class="n">integral_approx</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">distr</span><span class="p">(</span><span class="n">θ</span><span class="p">),</span> <span class="n">x</span><span class="p">),</span> <span class="n">θ</span><span class="p">)</span>
<span class="k">end</span>

<span class="n">θs</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="n">ID0s</span> <span class="o">=</span> <span class="n">ID_analytical</span><span class="o">.</span><span class="p">(</span><span class="n">θs</span><span class="p">)</span>
<span class="n">ID1s</span> <span class="o">=</span> <span class="n">ID_approx</span><span class="o">.</span><span class="p">(</span><span class="n">θs</span><span class="p">)</span>

<span class="n">scatter</span><span class="p">(</span><span class="n">θs</span><span class="p">,</span> <span class="n">first</span><span class="o">.</span><span class="p">(</span><span class="n">ID0s</span><span class="p">),</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">theta&#34;</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">&#34;integral&#34;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s">&#34;analytical&#34;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="p">)</span>
<span class="n">scatter!</span><span class="p">(</span><span class="n">θs</span><span class="p">,</span> <span class="n">first</span><span class="o">.</span><span class="p">(</span><span class="n">ID1s</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&#34;approximation&#34;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s">&#34;integral.svg&#34;</span><span class="p">)</span>

<span class="n">scatter</span><span class="p">(</span><span class="n">θs</span><span class="p">,</span> <span class="n">last</span><span class="o">.</span><span class="p">(</span><span class="n">ID0s</span><span class="p">),</span> <span class="n">xlab</span> <span class="o">=</span> <span class="s">&#34;</span><span class="se">\\</span><span class="s">theta&#34;</span><span class="p">,</span> <span class="n">ylab</span> <span class="o">=</span> <span class="s">&#34;derivative&#34;</span><span class="p">,</span>
        <span class="n">label</span> <span class="o">=</span> <span class="s">&#34;analytical&#34;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="o">:</span><span class="n">topleft</span><span class="p">)</span>
<span class="n">scatter!</span><span class="p">(</span><span class="n">θs</span><span class="p">,</span> <span class="n">last</span><span class="o">.</span><span class="p">(</span><span class="n">ID1s</span><span class="p">),</span> <span class="n">label</span> <span class="o">=</span> <span class="s">&#34;approximation&#34;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s">&#34;derivative.svg&#34;</span><span class="p">)</span>
</code></pre></div>
</div>



</div>

<script src="https://utteranc.es/client.js"
        repo="tpapp/tpapp.github.io"
        issue-term="pathname"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

    </div>
    <div id="smallscreenwarning">
      site not optimized for small screens, math may break
    </div>
  </body>
</html>

